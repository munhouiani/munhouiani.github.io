<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.munhou.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="TL;DRUber’s Petastorm library provides a data reader for PyTorch that reads files generated by PySpark. Clone the project from Github for more information.">
<meta property="og:type" content="article">
<meta property="og:title" content="Data Pipeline: From PySpark to PyTorch">
<meta property="og:url" content="https://blog.munhou.com/2020/01/16/Data-Pipeline-From-Pyspark-to-Pytorch/index.html">
<meta property="og:site_name" content="Mun Hou&#39;s Blog">
<meta property="og:description" content="TL;DRUber’s Petastorm library provides a data reader for PyTorch that reads files generated by PySpark. Clone the project from Github for more information.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-01-16T21:28:00.000Z">
<meta property="article:modified_time" content="2026-01-14T23:03:39.756Z">
<meta property="article:author" content="Mun Hou">
<meta property="article:tag" content="Deep Learning">
<meta property="article:tag" content="PyTorch">
<meta property="article:tag" content="Machine Learning">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.munhou.com/2020/01/16/Data-Pipeline-From-Pyspark-to-Pytorch/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://blog.munhou.com/2020/01/16/Data-Pipeline-From-Pyspark-to-Pytorch/","path":"2020/01/16/Data-Pipeline-From-Pyspark-to-Pytorch/","title":"Data Pipeline: From PySpark to PyTorch"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Data Pipeline: From PySpark to PyTorch | Mun Hou's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-345528590"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-345528590","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js" defer></script>








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Mun Hou's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#TL-DR"><span class="nav-number">1.</span> <span class="nav-text">TL;DR</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">2.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Data-Processing-PySpark"><span class="nav-number">3.</span> <span class="nav-text">Data Processing: PySpark</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PyTorch-Define-Model"><span class="nav-number">4.</span> <span class="nav-text">PyTorch: Define Model</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Petastorm-The-Data-Reader"><span class="nav-number">5.</span> <span class="nav-text">Petastorm: The Data Reader</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Model-Training"><span class="nav-number">6.</span> <span class="nav-text">Model Training</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Final-Words"><span class="nav-number">7.</span> <span class="nav-text">Final Words</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Mun Hou</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/munhouiani" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;munhouiani" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:munhou2022+blog@gmail.com" title="E-Mail → mailto:munhou2022+blog@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.munhou.com/2020/01/16/Data-Pipeline-From-Pyspark-to-Pytorch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Mun Hou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mun Hou's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Data Pipeline: From PySpark to PyTorch | Mun Hou's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Data Pipeline: From PySpark to PyTorch
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-17 05:28:00" itemprop="dateCreated datePublished" datetime="2020-01-17T05:28:00+08:00">2020-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-01-15 07:03:39" itemprop="dateModified" datetime="2026-01-15T07:03:39+08:00">2026-01-15</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/01/16/Data-Pipeline-From-Pyspark-to-Pytorch/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/16/Data-Pipeline-From-Pyspark-to-Pytorch/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h1><p>Uber’s Petastorm library provides a data reader for PyTorch that reads files generated by PySpark. <a target="_blank" rel="noopener" href="https://github.com/munhouiani/petastorm-demo">Clone the project from Github for more information.</a></p>
<span id="more"></span>


<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>As a data scientist, I spend much time wrangling data than making models, and the data scale from hundreds of millions to billions of pieces of records. Spark has been of great use to me due to its capability to process big data. Usually, I run all the dirty jobs with Spark and generated the-ready-to-use-files for the downstream model training process.</p>
<p>However, there is a gap between Spark and PyTorch, which is the data reader. As Spark runs in parallel, it writes multiple partitions of files by default. It’s painful that PyTorch doesn’t provide a data loader with the support of multiple files out of the box. While PyTorch gives a proper level of customisation, writing a high-efficiency data loader is not easy. Then, I found Petastorm.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/uber/petastorm">Petastorm</a> is an open-source data access library developed by Uber that provides more than a data loader. It supports multiple machine learning frameworks, such as TensorFlow, PyTorch, and PySpark. To install Petastorm, run</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install petastorm</span><br></pre></td></tr></table></figure>
<p>Check out their <a target="_blank" rel="noopener" href="https://github.com/uber/petastorm">repository</a> for more details.</p>
<p>In this post, I would like to demonstrate how I process data with PySpark, train a model with PyTorch and fill in the gap in between with Petastorm.</p>
<h1 id="Data-Processing-PySpark"><a href="#Data-Processing-PySpark" class="headerlink" title="Data Processing: PySpark"></a>Data Processing: PySpark</h1><p>We use the famous Iris flower data set as part of the demonstration. We load the CSV file with PySpark and create two new columns: the <code>features</code> column by assembling all the feature vectors and the <code>label</code> column by changing the class string to an integer.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">transform_iris_data</span>(<span class="params">data: DataFrame</span>):</span><br><span class="line">    data = (</span><br><span class="line">        data</span><br><span class="line">        .withColumn(<span class="string">&#x27;features&#x27;</span>,</span><br><span class="line">                    assemble_features(<span class="string">&#x27;sepal-length&#x27;</span>, <span class="string">&#x27;sepal-width&#x27;</span>, <span class="string">&#x27;petal-length&#x27;</span>, <span class="string">&#x27;petal-width&#x27;</span>)</span><br><span class="line">                    )</span><br><span class="line">        .withColumn(<span class="string">&#x27;label&#x27;</span>, transform_label(<span class="string">&#x27;class&#x27;</span>))</span><br><span class="line">        .select(<span class="string">&#x27;features&#x27;</span>, <span class="string">&#x27;label&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<p>After that, we split the data frame into the train set and test set.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">split_train_test</span>(<span class="params"></span></span><br><span class="line"><span class="params">        data: DataFrame, </span></span><br><span class="line"><span class="params">        train_ratio: <span class="built_in">float</span> = <span class="number">0.7</span>, </span></span><br><span class="line"><span class="params">        test_ratio: <span class="built_in">float</span> = <span class="number">0.3</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">return</span> data.randomSplit([train_ratio, test_ratio], seed=<span class="number">42</span>)</span><br></pre></td></tr></table></figure>

<p>Finally, we save the two data frames in parquet format.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(</span><br><span class="line">    train</span><br><span class="line">    .write</span><br><span class="line">    .mode(<span class="string">&#x27;overwrite&#x27;</span>)</span><br><span class="line">    .parquet(train_path)</span><br><span class="line">)</span><br><span class="line">(</span><br><span class="line">    test</span><br><span class="line">    .write</span><br><span class="line">    .mode(<span class="string">&#x27;overwrite&#x27;</span>)</span><br><span class="line">    .parquet(test_path)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h1 id="PyTorch-Define-Model"><a href="#PyTorch-Define-Model" class="headerlink" title="PyTorch: Define Model"></a>PyTorch: Define Model</h1><p>We build a simple three-layer network for this easy training task.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_linear_model</span>(<span class="params"></span></span><br><span class="line"><span class="params">        input_dim: <span class="built_in">int</span> = <span class="number">4</span>,</span></span><br><span class="line"><span class="params">        output_dim: <span class="built_in">int</span> = <span class="number">3</span>,</span></span><br><span class="line"><span class="params">        device=<span class="string">&#x27;cpu&#x27;</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    net = nn.Sequential(</span><br><span class="line">        nn.Linear(input_dim, <span class="number">6</span>),</span><br><span class="line">        nn.ReLU(),</span><br><span class="line">        nn.Linear(<span class="number">6</span>, <span class="number">4</span>),</span><br><span class="line">        nn.ReLU(),</span><br><span class="line">        nn.Linear(<span class="number">4</span>, output_dim)</span><br><span class="line">    ).to(device)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> net</span><br></pre></td></tr></table></figure>

<h1 id="Petastorm-The-Data-Reader"><a href="#Petastorm-The-Data-Reader" class="headerlink" title="Petastorm: The Data Reader"></a>Petastorm: The Data Reader</h1><p>Now, it’s time to build the data reader. Building a data reader is simple; what we have to do is to call <code>DataLoader</code> and <code>make_batch_reader</code>, passing in the data path, batch size, and the number of the epoch.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_data_loader</span>(<span class="params"></span></span><br><span class="line"><span class="params">        data_path: <span class="built_in">str</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        num_epochs: <span class="built_in">int</span> = <span class="number">1</span>,</span></span><br><span class="line"><span class="params">        batch_size: <span class="built_in">int</span> = <span class="number">16</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data_path:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> DataLoader(</span><br><span class="line">        make_batch_reader(</span><br><span class="line">            dataset_url=data_path,</span><br><span class="line">            num_epochs=num_epochs</span><br><span class="line">        ),</span><br><span class="line">        batch_size=batch_size</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>Keep in mind that the <code>dataset_url</code> must consist of the URL scheme. For example, if the data path is <code>/some/localpath/a_dataset</code>, you should pass in <code>file:///some/localpath/a_dataset</code>. Petastorm also supports <code>hdfs://</code> and <code>s3://</code>, but I haven’t tried them yet.</p>
<h1 id="Model-Training"><a href="#Model-Training" class="headerlink" title="Model Training"></a>Model Training</h1><p>The final step is to train our model.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_model</span>(<span class="params"></span></span><br><span class="line"><span class="params">        train_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        device: <span class="built_in">str</span> = <span class="string">&#x27;cpu&#x27;</span>,</span></span><br><span class="line"><span class="params">        num_epoch: <span class="built_in">int</span> = <span class="number">50</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="comment"># get model</span></span><br><span class="line">    model = get_linear_model()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># define loss function</span></span><br><span class="line">    loss_fun = torch.nn.CrossEntropyLoss()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># define optimiser</span></span><br><span class="line">    opt = torch.optim.Adam(model.parameters(), lr=<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line">    model.train()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epoch):</span><br><span class="line">        batch_losses = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> batch, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(get_data_loader(train_path)):</span><br><span class="line">            opt.zero_grad()</span><br><span class="line"></span><br><span class="line">            features = data[<span class="string">&#x27;features&#x27;</span>].to(device)</span><br><span class="line">            label = data[<span class="string">&#x27;label&#x27;</span>].to(device)</span><br><span class="line"></span><br><span class="line">            y_pred = model(features)</span><br><span class="line">            loss = loss_fun(y_pred, label)</span><br><span class="line"></span><br><span class="line">            loss.backward()</span><br><span class="line">            opt.step()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># track batch losses</span></span><br><span class="line">            batch_losses += loss.item()</span><br><span class="line"></span><br><span class="line">        avg_batch_loss = batch_losses / (batch + <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Epoch <span class="subst">&#123;epoch&#125;</span> average loss: <span class="subst">&#123;avg_batch_loss&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>

<p>Using a Petastorm data loader is just like using a PyTorch data loader: wrap it in a for loop.<br>Remember that the data frame previously generated by PySpark consists of only two columns? We can retrieve the values by writing <code>data[&#39;features&#39;]</code> and <code>data[&#39;label&#39;]</code>. If everything goes smoothly, you get a model with the following test performance:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                 precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">    Iris-setosa       1.00      1.00      1.00        11</span><br><span class="line">Iris-versicolor       1.00      1.00      1.00        13</span><br><span class="line"> Iris-virginica       1.00      1.00      1.00        12</span><br><span class="line"></span><br><span class="line">       accuracy                           1.00        36</span><br><span class="line">      macro avg       1.00      1.00      1.00        36</span><br><span class="line">   weighted avg       1.00      1.00      1.00        36</span><br></pre></td></tr></table></figure>

<h1 id="Final-Words"><a href="#Final-Words" class="headerlink" title="Final Words"></a>Final Words</h1><p>Petastorm is a reliable and helpful library. Be sure to check out their latest features!</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Deep-Learning/" rel="tag"># Deep Learning</a>
              <a href="/tags/PyTorch/" rel="tag"># PyTorch</a>
              <a href="/tags/Machine-Learning/" rel="tag"># Machine Learning</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/01/15/Summary-of-Malware-Detection-By-Eating-a-Whole-EXE-in-One-Picture/" rel="prev" title="Summary of Malware Detection By Eating a Whole EXE in One Picture">
                  <i class="fa fa-angle-left"></i> Summary of Malware Detection By Eating a Whole EXE in One Picture
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/03/01/ML-Prediction-with-XGBoost-and-PySpark/" rel="next" title="ML Prediction with XGBoost and PySpark">
                  ML Prediction with XGBoost and PySpark <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Mun Hou</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/munhouiani" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"munhousblog","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js" defer></script>

</body>
</html>
