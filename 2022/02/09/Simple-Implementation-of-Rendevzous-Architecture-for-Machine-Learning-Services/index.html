<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.munhou.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Stream-First Rendezvous ArchitectureThe rendezvous architecture was introduced by Ted Dunning in his book Machine Learning Logistics. This architecture is aimed to solve several real-world machine lea">
<meta property="og:type" content="article">
<meta property="og:title" content="Simple Implementation of Rendezvous Architecture for Machine Learning Services">
<meta property="og:url" content="https://blog.munhou.com/2022/02/09/Simple-Implementation-of-Rendevzous-Architecture-for-Machine-Learning-Services/index.html">
<meta property="og:site_name" content="Mun Hou&#39;s Blog">
<meta property="og:description" content="Stream-First Rendezvous ArchitectureThe rendezvous architecture was introduced by Ted Dunning in his book Machine Learning Logistics. This architecture is aimed to solve several real-world machine lea">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.munhou.com/images/rendezvous-arch/stream_first_arch.png">
<meta property="og:image" content="https://blog.munhou.com/images/rendezvous-arch/flow.png">
<meta property="article:published_time" content="2022-02-09T03:44:00.000Z">
<meta property="article:modified_time" content="2026-01-14T23:16:48.181Z">
<meta property="article:author" content="Mun Hou">
<meta property="article:tag" content="Machine Learning">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.munhou.com/images/rendezvous-arch/stream_first_arch.png">


<link rel="canonical" href="https://blog.munhou.com/2022/02/09/Simple-Implementation-of-Rendevzous-Architecture-for-Machine-Learning-Services/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://blog.munhou.com/2022/02/09/Simple-Implementation-of-Rendevzous-Architecture-for-Machine-Learning-Services/","path":"2022/02/09/Simple-Implementation-of-Rendevzous-Architecture-for-Machine-Learning-Services/","title":"Simple Implementation of Rendezvous Architecture for Machine Learning Services"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Simple Implementation of Rendezvous Architecture for Machine Learning Services | Mun Hou's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-345528590"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-345528590","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js" defer></script>








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Mun Hou's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Stream-First-Rendezvous-Architecture"><span class="nav-number">1.</span> <span class="nav-text">Stream-First Rendezvous Architecture</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Implementation"><span class="nav-number">2.</span> <span class="nav-text">Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Architecture-Diagram"><span class="nav-number">2.1.</span> <span class="nav-text">Architecture Diagram</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#predict-The-Front-End"><span class="nav-number">2.2.</span> <span class="nav-text">predict The Front End</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Prediction-Models"><span class="nav-number">2.3.</span> <span class="nav-text">Prediction Models</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Decoy-Model"><span class="nav-number">2.4.</span> <span class="nav-text">Decoy Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Log-Connector"><span class="nav-number">2.5.</span> <span class="nav-text">Log Connector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES-Connector"><span class="nav-number">2.6.</span> <span class="nav-text">ES Connector</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-Run"><span class="nav-number">3.</span> <span class="nav-text">How to Run</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">4.</span> <span class="nav-text">References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Mun Hou</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/munhouiani" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;munhouiani" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:munhou2022+blog@gmail.com" title="E-Mail → mailto:munhou2022+blog@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.munhou.com/2022/02/09/Simple-Implementation-of-Rendevzous-Architecture-for-Machine-Learning-Services/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Mun Hou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mun Hou's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Simple Implementation of Rendezvous Architecture for Machine Learning Services | Mun Hou's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Simple Implementation of Rendezvous Architecture for Machine Learning Services
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-09 11:44:00" itemprop="dateCreated datePublished" datetime="2022-02-09T11:44:00+08:00">2022-02-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-01-15 07:16:48" itemprop="dateModified" datetime="2026-01-15T07:16:48+08:00">2026-01-15</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2022/02/09/Simple-Implementation-of-Rendevzous-Architecture-for-Machine-Learning-Services/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/02/09/Simple-Implementation-of-Rendevzous-Architecture-for-Machine-Learning-Services/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Stream-First-Rendezvous-Architecture"><a href="#Stream-First-Rendezvous-Architecture" class="headerlink" title="Stream-First Rendezvous Architecture"></a>Stream-First Rendezvous Architecture</h2><p>The rendezvous architecture was introduced by Ted Dunning in his book <a target="_blank" rel="noopener" href="https://www.oreilly.com/library/view/machine-learning-logistics/9781491997628/ch03.html">Machine Learning Logistics</a>. This architecture is aimed to solve several real-world machine learning challenges:</p>
<ul>
<li>To meet large-scale changing data and changing goals.</li>
<li>Isolation of models for evaluation in specifically customized, controlled environments.</li>
<li>Managing multiple models in production at any given time.</li>
<li>Have new models being readied to replace production models as situations change smoothly and without interruptions to service.</li>
</ul>
<span id="more"></span>

<p><img src="/images/rendezvous-arch/stream_first_arch.png"><br>The heart of rendezvous architecture is to treat every input data as stream, i.e.:</p>
<ul>
<li>Put all requests into a stream; consumers (models) process input data when needed.</li>
<li>Outputs of models are put into another stream.</li>
<li>Rendezvous server works by maintaining a mailbox for each request it sees in the input stream. As each model reports results into the scores stream, the rendezvous server reads these results and inserts them into the corresponding mailbox.</li>
<li>Based on the amount of time that has passed, the priority of each model and possibly even a random number, the rendezvous server eventually chooses a result for each pending mailbox and packages that result to be sent as a response to the return address in the original request.</li>
</ul>
<p>If you are interested the details of rendezvous architecture for machine learning, I highly recommend reading the book <a target="_blank" rel="noopener" href="https://www.oreilly.com/library/view/machine-learning-logistics/9781491997628/">Machine Learning Logistics</a> and an article <a target="_blank" rel="noopener" href="https://towardsdatascience.com/rendezvous-architecture-for-data-science-in-production-79c4d48f12b">Rendezvous Architecture for Data Science in Production</a> written by Jan Teichmann.</p>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><h3 id="Architecture-Diagram"><a href="#Architecture-Diagram" class="headerlink" title="Architecture Diagram"></a>Architecture Diagram</h3><p><img src="/images/rendezvous-arch/flow.png"></p>
<h3 id="predict-The-Front-End"><a href="#predict-The-Front-End" class="headerlink" title="predict The Front End"></a><code>predict</code> The Front End</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">flower: Flower</span>):</span><br><span class="line">    _<span class="built_in">id</span> = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    message = &#123;</span><br><span class="line">        <span class="string">&quot;timestamp&quot;</span>: <span class="built_in">float</span>(datetime.datetime.now(datetime.timezone.utc).timestamp()),</span><br><span class="line">        <span class="string">&quot;messageId&quot;</span>: _<span class="built_in">id</span>,</span><br><span class="line">        <span class="string">&quot;modelInput&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;sepalLength&quot;</span>: flower.sepalLength,</span><br><span class="line">            <span class="string">&quot;sepalWidth&quot;</span>: flower.sepalWidth,</span><br><span class="line">            <span class="string">&quot;petalLength&quot;</span>: flower.petalLength,</span><br><span class="line">            <span class="string">&quot;petalWidth&quot;</span>: flower.petalWidth,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;scoreTopic&quot;</span>: ret_topic,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    publish_data(message)</span><br><span class="line">    result = get_model_result(_<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">    message[<span class="string">&quot;modelResult&quot;</span>] = result</span><br><span class="line">    message.pop(<span class="string">&quot;scoreTopic&quot;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> message</span><br></pre></td></tr></table></figure>

<p>Once <code>predict</code> receives a request, it publishes the request body to a topic, i.e., the <code>iris</code>. Then it waits for the result to be published to another topic, <code>score</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_model_result</span>(<span class="params">identifier</span>):</span><br><span class="line">    now = datetime.datetime.utcnow()</span><br><span class="line"></span><br><span class="line">    result = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (datetime.datetime.utcnow() - now) &lt; datetime.timedelta(seconds=timeout):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            msg = consumer.receive(<span class="number">2</span>)</span><br><span class="line">            data = json.loads(msg.data())</span><br><span class="line">            logger.debug(<span class="string">f&quot;Receive message: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">            consumer.acknowledge(msg)</span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&quot;messageId&quot;</span>] != identifier:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">or</span> (</span><br><span class="line">                data[<span class="string">&quot;provenance&quot;</span>][<span class="string">&quot;model&quot;</span>][<span class="string">&quot;modelVersion&quot;</span>]</span><br><span class="line">                &gt; result[<span class="string">&quot;provenance&quot;</span>][<span class="string">&quot;model&quot;</span>][<span class="string">&quot;modelVersion&quot;</span>]</span><br><span class="line">            ):</span><br><span class="line">                result = data</span><br><span class="line">        <span class="keyword">except</span> _pulsar.Timeout:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    model_result = result.get(<span class="string">&quot;result&quot;</span>, &#123;&#125;)</span><br><span class="line">    logger.debug(<span class="string">f&quot;Model result: <span class="subst">&#123;model_result&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> model_result</span><br></pre></td></tr></table></figure>

<p><code>get_model_result</code> gets results from the <code>score</code> topic and will only keep the result from the latest model by comparing the <code>modelVersion</code>. We also impose a time constraint <code>timeout</code> here to ensure our service responds in time.</p>
<h3 id="Prediction-Models"><a href="#Prediction-Models" class="headerlink" title="Prediction Models"></a>Prediction Models</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg = consumer.receive()</span><br><span class="line">    data = json.loads(msg.data())</span><br><span class="line">    logger.debug(<span class="string">f&quot;Receive message: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get ret addr</span></span><br><span class="line">    ret_topic = data[<span class="string">&quot;scoreTopic&quot;</span>]</span><br><span class="line">    producer = get_producer(client, ret_topic)</span><br><span class="line">    logger.debug(<span class="string">f&quot;Create a producer for topic <span class="subst">&#123;ret_topic&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    result = get_model_result(model, data)</span><br><span class="line">    request_timestamp = datetime.datetime.fromtimestamp(</span><br><span class="line">        <span class="built_in">float</span>(data[<span class="string">&quot;timestamp&quot;</span>]), datetime.timezone.utc</span><br><span class="line">    )</span><br><span class="line">    now_timestamp = datetime.datetime.now(datetime.timezone.utc)</span><br><span class="line">    time_after_request = (now_timestamp - request_timestamp).total_seconds() * <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    data[<span class="string">&quot;result&quot;</span>] = &#123;</span><br><span class="line">        <span class="string">&quot;modelName&quot;</span>: model_name,</span><br><span class="line">        <span class="string">&quot;result&quot;</span>: result,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;provenance&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">        data[<span class="string">&quot;provenance&quot;</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    data[<span class="string">&quot;provenance&quot;</span>][<span class="string">&quot;model&quot;</span>] = &#123;</span><br><span class="line">        <span class="string">&quot;modelName&quot;</span>: model_name,</span><br><span class="line">        <span class="string">&quot;elapsedTimeAfterRequest&quot;</span>: time_after_request,</span><br><span class="line">        <span class="string">&quot;modelVersion&quot;</span>: model_version,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    producer.send(json.dumps(data).encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    producer.flush()</span><br><span class="line">    producer.close()</span><br><span class="line">    logger.debug(<span class="string">f&quot;Sent data with producer: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    consumer.acknowledge(msg)</span><br></pre></td></tr></table></figure>

<p>We have two models, the <code>production model</code> is the latest, and the <code>canary model</code> is the baseline model. We’re trying to recreate the real-world scenario where we have a production model that is actively trained with the latest data, providing better performance. On the other hand, the canary model is usually the first model, intended to be used as a scoring baseline to compare with the production model. By comparing these two models, we can usually detect distribution shifts.</p>
<p>This model predict function will process every data from the <code>iris</code> topic and put model result and relevant debug message into the <code>provenance</code> data field.</p>
<h3 id="Decoy-Model"><a href="#Decoy-Model" class="headerlink" title="Decoy Model"></a>Decoy Model</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg = consumer.receive()</span><br><span class="line">    data = msg.data()</span><br><span class="line">    logger.debug(<span class="string">f&quot;Receive message: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    producer.send(data)</span><br><span class="line">    logger.debug(<span class="string">f&quot;Sent data with producer: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    consumer.acknowledge(msg)</span><br></pre></td></tr></table></figure>

<p>The decoy model accepts data like any other model but does not emit any result. Instead, it just archives the inputs that it sees.</p>
<h3 id="Log-Connector"><a href="#Log-Connector" class="headerlink" title="Log Connector"></a>Log Connector</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    time_diff = datetime.datetime.utcnow() - now</span><br><span class="line">    is_timeout = time_diff &gt; timeout</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(logs) &gt;= threshold <span class="keyword">or</span> is_timeout:</span><br><span class="line">        <span class="keyword">if</span> is_timeout:</span><br><span class="line">            now = datetime.datetime.utcnow()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> logs:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        filename = <span class="string">f&quot;log-<span class="subst">&#123;uuid.uuid4()&#125;</span>.gz&quot;</span></span><br><span class="line">        filepath = os.path.join(output_path, filename)</span><br><span class="line">        logger.debug(</span><br><span class="line">            <span class="string">f&quot;output log to <span class="subst">&#123;filepath&#125;</span> timeout: <span class="subst">&#123;is_timeout&#125;</span>, length: <span class="subst">&#123;<span class="built_in">len</span>(logs)&#125;</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">with</span> gzip.<span class="built_in">open</span>(filepath, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f_out:</span><br><span class="line">            <span class="keyword">for</span> log <span class="keyword">in</span> logs:</span><br><span class="line">                log = json.loads(log)</span><br><span class="line">                f_out.write(<span class="string">f&quot;<span class="subst">&#123;json.dumps(log)&#125;</span>\n&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">            logs.clear()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        msg = consumer.receive(<span class="number">2</span>)</span><br><span class="line">        data = msg.data()</span><br><span class="line">        logger.debug(<span class="string">f&quot;Received data <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">        logs.append(data)</span><br><span class="line">        consumer.acknowledge(msg)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<p>The <code>log_collector</code> archives every data we received for every <code>timeout</code> second.</p>
<h3 id="ES-Connector"><a href="#ES-Connector" class="headerlink" title="ES Connector"></a>ES Connector</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg = consumer.receive()</span><br><span class="line">    data = json.loads(msg.data())</span><br><span class="line">    <span class="comment"># fix timestamp</span></span><br><span class="line">    data[<span class="string">&quot;timestamp&quot;</span>] = datetime.datetime.fromtimestamp(</span><br><span class="line">        <span class="built_in">int</span>(data[<span class="string">&quot;timestamp&quot;</span>]), tz=datetime.timezone.utc</span><br><span class="line">    )</span><br><span class="line">    logger.debug(<span class="string">f&quot;Received data <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    res = es.index(index=elastic_index, body=data)</span><br><span class="line">    consumer.acknowledge(msg)</span><br></pre></td></tr></table></figure>

<p>We also put every result to the elastic search for analytic purposes.</p>
<h2 id="How-to-Run"><a href="#How-to-Run" class="headerlink" title="How to Run"></a>How to Run</h2><p>Clone my repo here at <a target="_blank" rel="noopener" href="https://github.com/munhouiani/rendezvous-arch">https://github.com/munhouiani/rendezvous-arch</a></p>
<ol>
<li><p>Install docker and docker compose.</p>
</li>
<li><p>Create conda environment</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda <span class="built_in">env</span> create -f env_mac.yaml</span><br><span class="line">conda activate rendezvous_arch</span><br></pre></td></tr></table></figure>
</li>
<li><p>Train <code>canary</code> and <code>production</code> model</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make train-canary</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make train-model</span><br></pre></td></tr></table></figure>
</li>
<li><p>Deploy services</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make up</span><br></pre></td></tr></table></figure>

<p>Wait for several minutes until all services are ready.</p>
</li>
<li><p>Make an HTTP-GET request to <code>http://localhost:8000/ping</code>, should get</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;ping&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pong&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Make an HTTP-POST request to <code>localhost:8000/predict</code> with body:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;sepalLength&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;sepalWidth&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;petalLength&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;petalWidth&quot;</span><span class="punctuation">:</span> <span class="number">12</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>should get</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1644370787.021771</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;messageId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cec42337-49ad-4f19-a478-69a1ef480e8a&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;modelInput&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;sepalLength&quot;</span><span class="punctuation">:</span> <span class="number">9.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sepalWidth&quot;</span><span class="punctuation">:</span> <span class="number">10.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;petalLength&quot;</span><span class="punctuation">:</span> <span class="number">11.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;petalWidth&quot;</span><span class="punctuation">:</span> <span class="number">12.0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;modelResult&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;modelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dt&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create indices for <code>decoy-log</code> and <code>score-log</code> at Kibana <code>http://localhost:5601</code>.</p>
</li>
</ol>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.slideshare.net/tdunning/streaming-architecture-including-rendezvous-for-machine-learning">Streaming Architecture including Rendezvous for Machine Learning</a></li>
<li><a target="_blank" rel="noopener" href="https://www.oreilly.com/library/view/machine-learning-logistics/9781491997628/">Machine Learning Logistics</a></li>
<li><a target="_blank" rel="noopener" href="https://towardsdatascience.com/rendezvous-architecture-for-data-science-in-production-79c4d48f12b">Rendezvous Architecture for Data Science in Production</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Machine-Learning/" rel="tag"># Machine Learning</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/09/29/Drug-Listing-Dataset/" rel="prev" title="Drug Listing Dataset">
                  <i class="fa fa-angle-left"></i> Drug Listing Dataset
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/12/01/Detecting%20Out-of-Distribution%20Samples%20with%20Knn/" rel="next" title="Detecting Out-of-Distribution Samples with kNN">
                  Detecting Out-of-Distribution Samples with kNN <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Mun Hou</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/munhouiani" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"munhousblog","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js" defer></script>

</body>
</html>
